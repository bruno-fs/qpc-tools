---

- name: Check if EPEL is installed
  yum:
    name: epel-release
    state: installed
  register: have_epel_raw
  become: true
  ignore_errors: yes
  when:
    - have_yum|bool

- name: Set fact indicating whether EPEL was found
  set_fact:
    have_epel: "{{ 'epel-release is already installed' in have_epel_raw['results'][0] }}"
  when:
    - "'results' in have_epel_raw"
    - have_epel_raw.failed != true

- name: Default fact indicating whether EPEL was found to false
  set_fact:
    have_epel: false
  when:
    - have_epel is not defined

- name: Install EPEL for CentOS/RHEL 6 from internet
  yum:
    name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm
    state: present
  become: true
  when:
    - is_rhel_centos_6|bool
    - not have_epel

- name: Install EPEL for CentOS/RHEL 7 from internet
  yum:
    name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
    state: present
  become: true
  when:
    - is_rhel_centos_7|bool
    - not have_epel

- name: Assign CLI version passed in by user to cli_version variable
  set_fact:
    install_flag_cli_version: "{{ cli_version }}"
  when:
    - cli_version is defined

- name: Set the base URL for the QPC CLI yum install (user specified version)
  set_fact:
    cli_github_release_url: "https://github.com/quipucords/qpc/releases/download/{{ install_flag_cli_version }}"
  when:
    - install_flag_cli_version is defined

- name: Set the base URL for the QPC CLI yum install (latest version)
  set_fact:
    cli_github_release_url: "https://github.com/quipucords/qpc/releases/latest/download"
  when:
    - install_flag_cli_version is not defined

- name: Install QPC CLI
  yum:
    name: '{{ cli_github_release_url }}/{{ qpc_package_name }}'
    state: present
  become: true
